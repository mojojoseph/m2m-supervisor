#!/usr/bin/env node

var _ = require('lodash');

var builder = require('../lib/device-builder');

var callback = null;
var device = new builder.newDevice({type: 'file',inFile: '/dev/ttyUSB2',outFile: '/dev/ttyUSB2',serialPort: '/dev/ttyUSB2',serialBaudRate: 460800});
device
    .on('data',function(data){
console.log('DATA: ' + data);
        _.each(data.toString().split('\n'),function(line){
console.log('LINE: ' + line);
            if (line.length > 0 && callback) callback(line);
        });
    })
    .on('error',function(error){
        console.log('error: ' + error);
        process.exit(1);
    })
    .on('retry',function(error){
        console.log('retry error: ' + error);
        process.exit(1);
    })
    .on('ready',function(){
        sendExpect('AT+CGMI','',function(){
            sendExpect('AT+CGMM','',function(){
                sendExpect('AT+CGMR','',function(){
                    sendExpect('AT+CSQ','',function(){
                        device.close();
                    })
                })
            })
        });
    })
    .open();

function sendExpect(command,prefix,done){
    var commandSeen = false;
    var prefixSeen = false;
    console.log('COMMAND: ' + command);
    callback = function(data){
        var check = '';
        if (!commandSeen && data === command) {
            commandSeen = true;
            check = ' - command';
        } else {//if (!prefixSeen && _.startsWith(data,prefix)) {
            prefixSeen = true;
            check = ' - match';
        }
        console.log('data: ' + data + check);
        if (data === 'OK' && commandSeen && prefixSeen) {
            callback = null;
            done && done();
        }
    };
    device.writeBuffer(command + '\n\n',function(error){
        if (error) console.log('callback error: ' + error);
    });
}
