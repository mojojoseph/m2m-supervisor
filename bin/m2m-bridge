#!/usr/bin/env node

var M2mProxy = require('../lib/m2m-proxy');
var RedisCheckpoint = require('../services/redis-checkpoint');
var ConfigCheckpoint = require('../services/config-checkpoint');
var RouteWatcher = require('../services/route-watcher');
var ModemWatcher = require('../services/modem-watcher');
var HeartbeatGenerator = require('../services/heartbeat-generator');

var schema = require('../lib/redis-schema');
var hashkeys = require('../lib/config-hashkeys');

var redisChk = new RedisCheckpoint().start(function(event,redis) {
    console.log('redis:' + event);
    if (event !== 'ready') return;

    var configChk = new ConfigCheckpoint(redis,hashkeys.gateway).start(function(event,gateway) {
        console.log('config:' + event);
        if (event !== 'ready') return;

        var heartbeat = null;
        var modem = null;
        var proxy = new M2mProxy(redis,gateway);
        var route = new RouteWatcher(gateway)  // TODO detect failure and stop the dependent objects... then restart on ready
            .on('ready',function(){ if (!modem) {
                modem = new ModemWatcher(gateway)
                    .on('ready',function(){ if (!heartbeat) heartbeat = new HeartbeatGenerator(redis,proxy).start(); })
                    .on('imei',function(imei){
                        if (!gateway.imei)  proxy.gateway.imei = gateway.imei = imei;
                        redis.hsetnx(schema.config.key,hashkeys.gateway.imei.key,imei);
                    })
                    .start();
            }})
            .start();
    });
});
