#!/usr/bin/env node

var GatewayProxy = require('../services/gateway-proxy');
var RedisWatcher = require('../services/redis-watcher');
var HashWatcher = require('../services/hash-watcher');
var RouteWatcher = require('../services/route-watcher');
var ModemWatcher = require('../services/modem-watcher');
var HeartbeatGenerator = require('../services/heartbeat-generator');

var schema = require('../lib/redis-schema');
var hashkeys = require('../lib/config-hashkeys');

var modemWatcher = new ModemWatcher()
    .on('imei',function(imei){ RedisWatcher.instance.client.hsetnx(schema.config.key,hashkeys.gateway.imei.key,imei); });

var routeWatcher = new RouteWatcher();

var proxy = new GatewayProxy();
var heartbeat = new HeartbeatGenerator();
var configWatcher = new HashWatcher(schema.config.key,hashkeys)
    .addKeysetWatcher('PPP',true,routeWatcher)
    .addKeysetWatcher('modem',true,modemWatcher)
    .addKeysetWatcher('gateway',false,proxy)
    .addKeysetWatcher('gateway',true,heartbeat);

new RedisWatcher()
    .addClientWatcher(configWatcher)
    .addClientWatcher(routeWatcher)
    .start();
